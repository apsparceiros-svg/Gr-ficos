<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Profissional - Imóveis</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
body { font-family: Arial, sans-serif; background:#f4f4f9; margin:0; padding:20px; }
h1 { text-align:center; color:#8e44ad; margin-bottom:20px; }
.controls { display:flex; gap:15px; justify-content:center; margin-bottom:20px; flex-wrap:wrap; }
.controls select { padding:8px; border-radius:5px; border:1px solid #ccc; }
.chart { width:100%; max-width:1000px; margin:0 auto 50px; height:600px; }
</style>
</head>
<body>
<h1>Dashboard Profissional - Imóveis</h1>

<div class="controls">
  <select id="filterCidade"><option value="">Todas as Cidades</option></select>
  <select id="filterBairro"><option value="">Todos os Bairros</option></select>
  <select id="filterOperacao"><option value="">Todas Operações</option></select>
  <select id="filterTipo"><option value="">Todos os Tipos</option></select>
</div>

<div id="chart3D" class="chart"></div>
<div id="chartBairro" class="chart"></div>
<div id="chartOperacao" class="chart"></div>
<div id="chartTipo" class="chart"></div>

<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQP-T1jc4Rpdigxqpkf7cL0MYiA8IESg1ATBwVdT7gTTPaMll_LGuwj0zOfbeEIO8Qv3DOZsK6eNBrZ/pub?gid=11391417&single=true&output=csv";

let rawData = [];
let filters = {cidade:"", bairro:"", operacao:"", tipo:""};

function fetchData() {
    Papa.parse(csvUrl, {
        download: true,
        header: true,
        dynamicTyping: true,
        complete: function(results) {
            rawData = results.data.filter(d => d.preco); // remove linhas sem preço
            populateFilters();
            updateCharts();
        }
    });
}

function populateFilters() {
    const cidades = [...new Set(rawData.map(d=>d.cidade).filter(Boolean))].sort();
    const bairros = [...new Set(rawData.map(d=>d.bairro).filter(Boolean))].sort();
    const operacoes = [...new Set(rawData.map(d=>d.operacao).filter(Boolean))].sort();
    const tipos = [...new Set(rawData.map(d=>d.tipo).filter(Boolean))].sort();

    cidades.forEach(c=> document.getElementById('filterCidade').innerHTML += `<option value="${c}">${c}</option>`);
    bairros.forEach(b=> document.getElementById('filterBairro').innerHTML += `<option value="${b}">${b}</option>`);
    operacoes.forEach(o=> document.getElementById('filterOperacao').innerHTML += `<option value="${o}">${o}</option>`);
    tipos.forEach(t=> document.getElementById('filterTipo').innerHTML += `<option value="${t}">${t}</option>`);

    document.getElementById('filterCidade').onchange = (e)=>{ filters.cidade=e.target.value; updateCharts(); };
    document.getElementById('filterBairro').onchange = (e)=>{ filters.bairro=e.target.value; updateCharts(); };
    document.getElementById('filterOperacao').onchange = (e)=>{ filters.operacao=e.target.value; updateCharts(); };
    document.getElementById('filterTipo').onchange = (e)=>{ filters.tipo=e.target.value; updateCharts(); };
}

function filterData() {
    return rawData.filter(d=>{
        return (!filters.cidade || d.cidade===filters.cidade)
            && (!filters.bairro || d.bairro===filters.bairro)
            && (!filters.operacao || d.operacao===filters.operacao)
            && (!filters.tipo || d.tipo===filters.tipo);
    });
}

function avg(arr) { return arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : 0; }

function updateCharts() {
    const data = filterData();

    // 3D Cidade x Tipo x Preço
    const cidades = [...new Set(data.map(d=>d.cidade).filter(Boolean))];
    const tipos = [...new Set(data.map(d=>d.tipo).filter(Boolean))];
    const z = tipos.map(tipo => cidades.map(cidade => {
        const valores = data.filter(d=>d.cidade===cidade && d.tipo===tipo).map(d=>d.preco);
        return avg(valores);
    }));

    Plotly.newPlot('chart3D',[{
        x:cidades, y:tipos, z:z, type:'surface', colorscale:'Viridis',
        contours:{z:{show:true,usecolormap:true,highlightcolor:"#42f462",project:{z:true}}},
        hovertemplate:"Cidade: %{x}<br>Tipo: %{y}<br>Preço Médio: %{z}<extra></extra>"
    }],{
        title:'Preço Médio por Cidade e Tipo (3D)',
        scene:{xaxis:{title:'Cidade'},yaxis:{title:'Tipo'},zaxis:{title:'Preço (R$)'}},
        margin:{l:50,r:50,b:50,t:50}
    });

    // Preço Médio por Bairro
    const bairros = [...new Set(data.map(d=>d.bairro).filter(Boolean))];
    const precoBairro = bairros.map(b => avg(data.filter(d=>d.bairro===b).map(d=>d.preco)));
    Plotly.newPlot('chartBairro',[{
        x:bairros, y:precoBairro, type:'bar', marker:{color:'#e67e22'},
        hovertemplate:"Bairro: %{x}<br>Preço Médio: %{y}<extra></extra>"
    }],{title:'Preço Médio por Bairro', xaxis:{title:'Bairro'}, yaxis:{title:'Preço (R$)'}});

    // Preço Médio por Operação
    const operacoes = [...new Set(data.map(d=>d.operacao).filter(Boolean))];
    const precoOperacao = operacoes.map(o => avg(data.filter(d=>d.operacao===o).map(d=>d.preco)));
    Plotly.newPlot('chartOperacao',[{
        x:operacoes, y:precoOperacao, type:'bar', marker:{color:'#3498db'},
        hovertemplate:"Operação: %{x}<br>Preço Médio: %{y}<extra></extra>"
    }],{title:'Preço Médio por Operação', xaxis:{title:'Operação'}, yaxis:{title:'Preço (R$)'}});

    // Preço Médio por Tipo
    const tipos2 = [...new Set(data.map(d=>d.tipo).filter(Boolean))];
    const precoTipo = tipos2.map(t => avg(data.filter(d=>d.tipo===t).map(d=>d.preco)));
    Plotly.newPlot('chartTipo',[{
        x:tipos2, y:precoTipo, type:'bar', marker:{color:'#2ecc71'},
        hovertemplate:"Tipo: %{x}<br>Preço Médio: %{y}<extra></extra>"
    }],{title:'Preço Médio por Tipo', xaxis:{title:'Tipo'}, yaxis:{title:'Preço (R$)'}});
}

fetchData();
</script>
</body>
</html>
