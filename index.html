<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Avançado - Imóveis</title>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
body { font-family: 'Roboto', sans-serif; background: #f4f4f9; color: #333; margin:0; padding:20px;}
h1 { text-align:center; color:#8e44ad; margin-bottom: 30px;}
.controls { display:flex; flex-wrap:wrap; gap:15px; justify-content:center; margin-bottom:20px; }
select { padding:8px 12px; border-radius:6px; border:1px solid #ccc;}
#charts { display:grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap:30px; }
.chart-container { width:100%; background:#fff; padding:15px; border-radius:10px; box-shadow:0 4px 15px rgba(0,0,0,0.1);}
@media(max-width:600px){ #charts { grid-template-columns: 1fr; } }
</style>
</head>
<body>
<h1>Dashboard Avançado de Imóveis</h1>

<div class="controls">
  <select id="filterCidade"><option value="">Todas as Cidades</option></select>
  <select id="filterBairro"><option value="">Todos os Bairros</option></select>
  <select id="filterTipo"><option value="">Todos os Tipos</option></select>
  <select id="filterOperacao"><option value="">Todas as Operações</option></select>
</div>

<div id="charts">
  <div class="chart-container" id="chartCidade"></div>
  <div class="chart-container" id="chartBairro"></div>
  <div class="chart-container" id="chartTipo"></div>
  <div class="chart-container" id="chartOperacao"></div>
  <div class="chart-container" id="chartOperacaoTipo"></div>
  <div class="chart-container" id="chartTop10"></div>
  <div class="chart-container" id="chartScatter"></div>
</div>

<script>
google.charts.load('current', {'packages':['corechart', 'bar', 'table', 'scatter']});
google.charts.setOnLoadCallback(loadData);

const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQP-T1jc4Rpdigxqpkf7cL0MYiA8IESg1ATBwVdT7gTTPaMll_LGuwj0zOfbeEIO8Qv3DOZsK6eNBrZ/pub?gid=11391417&single=true&output=csv';

let rawData = [];

function loadData() {
  Papa.parse(csvUrl, {
    download:true,
    header:true,
    skipEmptyLines:true,
    complete: function(results){
      rawData = results.data.map(r => ({
        ref: r.ref,
        titulo: r.titulo,
        operacao: r.operacao,
        tipo: r.tipo,
        cidade: r.cidade,
        bairro: r.bairro,
        preco: parseFloat(r.preco.replace(/\./g,'').replace(',','.')) || 0
      }));
      populateFilters();
      drawAllCharts();
    }
  });
}

function populateFilters() {
  const cidades = Array.from(new Set(rawData.map(d=>d.cidade))).sort();
  const bairros = Array.from(new Set(rawData.map(d=>d.bairro))).sort();
  const tipos = Array.from(new Set(rawData.map(d=>d.tipo))).sort();
  const operacoes = Array.from(new Set(rawData.map(d=>d.operacao))).sort();

  const selectC = document.getElementById('filterCidade');
  const selectB = document.getElementById('filterBairro');
  const selectT = document.getElementById('filterTipo');
  const selectO = document.getElementById('filterOperacao');

  cidades.forEach(c=>selectC.innerHTML += `<option value="${c}">${c}</option>`);
  bairros.forEach(b=>selectB.innerHTML += `<option value="${b}">${b}</option>`);
  tipos.forEach(t=>selectT.innerHTML += `<option value="${t}">${t}</option>`);
  operacoes.forEach(o=>selectO.innerHTML += `<option value="${o}">${o}</option>`);

  [selectC, selectB, selectT, selectO].forEach(sel => sel.addEventListener('change', drawAllCharts));
}

function getFilteredData() {
  const cidade = document.getElementById('filterCidade').value;
  const bairro = document.getElementById('filterBairro').value;
  const tipo = document.getElementById('filterTipo').value;
  const operacao = document.getElementById('filterOperacao').value;

  return rawData.filter(d=> 
    (cidade==='' || d.cidade===cidade) &&
    (bairro==='' || d.bairro===bairro) &&
    (tipo==='' || d.tipo===tipo) &&
    (operacao==='' || d.operacao===operacao)
  );
}

function aggregateAvg(data, key) {
  const grouped = {};
  data.forEach(d=>{
    if(!grouped[d[key]]) grouped[d[key]] = {sum:0, count:0};
    grouped[d[key]].sum += d.preco;
    grouped[d[key]].count++;
  });
  return Object.entries(grouped).map(([k,v])=>[k, v.sum/v.count]);
}

function drawAllCharts() {
  const data = getFilteredData();

  function drawColumnChart(divId, title, key, color){
    let dt = new google.visualization.DataTable();
    dt.addColumn('string', key);
    dt.addColumn('number', 'Preço Médio');
    aggregateAvg(data, key.toLowerCase()).forEach(d=>dt.addRow(d));
    new google.visualization.ColumnChart(document.getElementById(divId)).draw(dt,{
      title:title,
      is3D:true,
      hAxis:{title:key},
      vAxis:{title:'Preço (R$)'},
      colors:[color],
      backgroundColor:'#f4f4f4'
    });
  }

  drawColumnChart('chartCidade','Preço Médio por Cidade','Cidade','#3498db');
  drawColumnChart('chartBairro','Preço Médio por Bairro','Bairro','#e67e22');
  drawColumnChart('chartTipo','Preço Médio por Tipo','Tipo','#2ecc71');
  drawColumnChart('chartOperacao','Preço Médio por Operação','Operação','#9b59b6');

  // Operação + Tipo
  let grouped = {};
  data.forEach(d=>{
    const key = d.operacao + ' - ' + d.tipo;
    if(!grouped[key]) grouped[key] = {sum:0, count:0};
    grouped[key].sum += d.preco;
    grouped[key].count++;
  });
  let dtOpTipo = new google.visualization.DataTable();
  dtOpTipo.addColumn('string','Operação - Tipo');
  dtOpTipo.addColumn('number','Preço Médio');
  Object.entries(grouped).forEach(([k,v])=>dtOpTipo.addRow([k, v.sum/v.count]));
  new google.visualization.BarChart(document.getElementById('chartOperacaoTipo')).draw(dtOpTipo,{
    title:'Preço Médio por Operação + Tipo',
    is3D:true,
    hAxis:{title:'Preço (R$)'},
    vAxis:{title:'Operação - Tipo'},
    colors:['#e74c3c'],
    backgroundColor:'#f4f4f4'
  });

  // Top 10 imóveis
  let top10 = [...data].sort((a,b)=>b.preco - a.preco).slice(0,10);
  let dtTop10 = new google.visualization.DataTable();
  dtTop10.addColumn('string','Título');
  dtTop10.addColumn('number','Preço (R$)');
  dtTop10.addColumn('string','Cidade');
  dtTop10.addColumn('string','Bairro');
  top10.forEach(d=>dtTop10.addRow([d.titulo,d.preco,d.cidade,d.bairro]));
  new google.visualization.Table(document.getElementById('chartTop10')).draw(dtTop10,{
    showRowNumber:true, width:'100%', height:'auto'
  });

  // Scatter
  let dtScatter = new google.visualization.DataTable();
  dtScatter.addColumn('string','Tipo');
  dtScatter.addColumn('string','Operação');
  dtScatter.addColumn('number','Preço');
  dtScatter.addColumn({type:'string', role:'tooltip'});
  data.forEach(d=>{
    dtScatter.addRow([d.tipo,d.operacao,d.preco,
      `Título: ${d.titulo}\nCidade: ${d.cidade}\nBairro: ${d.bairro}\nPreço: R$ ${d.preco.toLocaleString()}`]);
  });
  new google.visualization.ScatterChart(document.getElementById('chartScatter')).draw(dtScatter,{
    title:'Scatter: Preço x Tipo x Operação',
    hAxis:{title:'Tipo'},
    vAxis:{title:'Preço (R$)'},
    bubble:{textStyle:{fontSize:11}},
    tooltip:{isHtml:true},
    colors:['#16a085'],
    backgroundColor:'#f4f4f4'
  });
}
</script>
</body>
</html>
