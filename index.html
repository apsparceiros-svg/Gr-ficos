<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gráficos Profissionais - Imóveis</title>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<style>
body { font-family: 'Roboto', sans-serif; background:#f4f4f9; color:#333; margin:0; padding:20px; }
h2 { text-align:center; color:#8e44ad; margin-bottom:30px; }
.wrapper { display:flex; flex-wrap:wrap; justify-content:center; gap:30px; }
.chart-container { width:100%; max-width:900px; background:#fff; padding:15px; border-radius:10px; box-shadow:0 4px 15px rgba(0,0,0,0.1);}
@media(max-width:768px){ .chart-container{ width:95%; } }
</style>
</head>
<body>
<h2>Gráficos Profissionais - Imóveis</h2>
<div class="wrapper">
    <div class="chart-container"><div id="chart_bairro" style="height:450px;"></div></div>
    <div class="chart-container"><div id="chart_cidade" style="height:450px;"></div></div>
    <div class="chart-container"><div id="chart_tipo" style="height:450px;"></div></div>
    <div class="chart-container"><div id="chart_operacao" style="height:450px;"></div></div>
    <div class="chart-container"><div id="chart_operacao_tipo" style="height:450px;"></div></div>
</div>

<script type="text/javascript">
google.charts.load('current', {packages: ['corechart', 'bar']});
google.charts.setOnLoadCallback(drawCharts);

function drawCharts() {
    const csvURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQP-T1jc4Rpdigxqpkf7cL0MYiA8IESg1ATBwVdT7gTTPaMll_LGuwj0zOfbeEIO8Qv3DOZsK6eNBrZ/pub?gid=11391417&single=true&output=csv";
    
    Papa.parse(csvURL, {
        download:true,
        header:true,
        complete:function(results){
            const data = results.data.filter(r=>r.preco && r.operacao && r.tipo && r.bairro && r.cidade);
            
            // Função para agrupar e calcular média
            function agruparMedia(array, key){
                const mapa = {};
                array.forEach(item=>{
                    let precoNum = parseFloat(item.preco.replace(/[^\d\.]/g,''));
                    if(isNaN(precoNum)) return;
                    const k = item[key];
                    if(!mapa[k]) mapa[k] = [];
                    mapa[k].push(precoNum);
                });
                const arr = [["Categoria","Preço Médio"]];
                for(const k in mapa){
                    const soma = mapa[k].reduce((a,b)=>a+b,0);
                    arr.push([k, soma/mapa[k].length]);
                }
                return google.visualization.arrayToDataTable(arr);
            }

            // Gráfico Bairro
            new google.visualization.ColumnChart(document.getElementById('chart_bairro'))
                .draw(agruparMedia(data,"bairro"), {title:"Preço Médio por Bairro", is3D:true, backgroundColor:'#f4f4f4', colors:['#e67e22']});

            // Gráfico Cidade
            new google.visualization.ColumnChart(document.getElementById('chart_cidade'))
                .draw(agruparMedia(data,"cidade"), {title:"Preço Médio por Cidade", is3D:true, backgroundColor:'#f4f4f4', colors:['#16a085']});

            // Gráfico Tipo
            new google.visualization.ColumnChart(document.getElementById('chart_tipo'))
                .draw(agruparMedia(data,"tipo"), {title:"Preço Médio por Tipo", is3D:true, backgroundColor:'#f4f4f4', colors:['#3498db']});

            // Gráfico Operação
            new google.visualization.ColumnChart(document.getElementById('chart_operacao'))
                .draw(agruparMedia(data,"operacao"), {title:"Preço Médio por Operação", is3D:true, backgroundColor:'#f4f4f4', colors:['#9b59b6']});

            // Gráfico Operação + Tipo
            const comboMap = {};
            data.forEach(item=>{
                let precoNum = parseFloat(item.preco.replace(/[^\d\.]/g,''));
                if(isNaN(precoNum)) return;
                const k = item.operacao + " - " + item.tipo;
                if(!comboMap[k]) comboMap[k] = [];
                comboMap[k].push(precoNum);
            });
            const comboArr = [["Operação - Tipo","Preço Médio"]];
            for(const k in comboMap){
                const soma = comboMap[k].reduce((a,b)=>a+b,0);
                comboArr.push([k, soma/comboMap[k].length]);
            }
            new google.visualization.BarChart(document.getElementById('chart_operacao_tipo'))
                .draw(google.visualization.arrayToDataTable(comboArr), {title:"Preço Médio por Operação + Tipo", is3D:true, backgroundColor:'#f4f4f4', colors:['#e74c3c']});
        }
    });
}
</script>
</body>
</html>
