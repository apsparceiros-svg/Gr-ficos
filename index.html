<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Avançado - Imóveis</title>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
body { font-family:'Roboto', sans-serif; background:#f4f4f9; margin:0; padding:0; color:#333;}
h2 { text-align:center; color:#8e44ad; margin:20px 0;}
.wrapper { display:flex; flex-wrap:wrap; justify-content:center; gap:30px; padding:20px;}
.chart-container { background:#fff; border-radius:12px; padding:15px; box-shadow:0 4px 12px rgba(0,0,0,0.1); max-width:600px; flex:1 1 500px;}
#filters { display:flex; gap:20px; justify-content:center; flex-wrap:wrap; margin-bottom:20px;}
select { padding:8px 12px; border-radius:6px; border:1px solid #d3b28d; background:#fff;}
</style>
<script>
google.charts.load('current', {packages:['corechart','controls','bar','table']});
google.charts.setOnLoadCallback(loadData);

const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQP-T1jc4Rpdigxqpkf7cL0MYiA8IESg1ATBwVdT7gTTPaMll_LGuwj0zOfbeEIO8Qv3DOZsK6eNBrZ/pub?gid=11391417&single=true&output=csv";

function loadData() {
  Papa.parse(csvUrl, {download:true, header:true, complete: function(results){
    const rows = results.data.filter(r => r.preco && !isNaN(Number(r.preco)));
    const data = new google.visualization.DataTable();
    data.addColumn('string','Operação');
    data.addColumn('string','Tipo');
    data.addColumn('string','Cidade');
    data.addColumn('string','Bairro');
    data.addColumn('number','Preço');
    data.addColumn('number','Área');

    rows.forEach(r => {
      data.addRow([
        r.operacao||"",
        r.tipo||"",
        r.cidade||"",
        r.bairro||"",
        Number(r.preco)||0,
        Number(r.area)||0
      ]);
    });

    drawDashboard(data);
  }});
}

function drawDashboard(data) {
  const dashboard = new google.visualization.Dashboard(document.getElementById('dashboard'));

  const operationFilter = new google.visualization.ControlWrapper({
    controlType:'CategoryFilter',
    containerId:'filter_operacao',
    options:{filterColumnLabel:'Operação', ui:{allowTyping:false, allowMultiple:true}}
  });

  const typeFilter = new google.visualization.ControlWrapper({
    controlType:'CategoryFilter',
    containerId:'filter_tipo',
    options:{filterColumnLabel:'Tipo', ui:{allowTyping:false, allowMultiple:true}}
  });

  const cityFilter = new google.visualization.ControlWrapper({
    controlType:'CategoryFilter',
    containerId:'filter_cidade',
    options:{filterColumnLabel:'Cidade', ui:{allowTyping:false, allowMultiple:true}}
  });

  // Função para criar DataView agregada
  function aggregateDataView(columnKey, valueColumn = 'Preço') {
    const view = new google.visualization.DataView(data);
    const map = {};
    for(let i=0; i<view.getNumberOfRows(); i++) {
      const key = view.getValue(i, columnKey);
      const val = view.getValue(i, 4); // Preço
      if(!map[key]) map[key]=[];
      map[key].push(val);
    }
    const table = new google.visualization.DataTable();
    table.addColumn('string','Key');
    table.addColumn('number','Preço Médio');
    Object.keys(map).forEach(k=>{
      const vals = map[k];
      const avg = vals.reduce((a,b)=>a+b,0)/vals.length;
      table.addRow([k, avg]);
    });
    return table;
  }

  // Gráficos
  const chartBairro = new google.visualization.ChartWrapper({chartType:'ColumnChart', containerId:'chart_bairro', options:{title:'Preço Médio por Bairro', height:400, legend:'none', colors:['#e67e22']}});
  const chartOperacao = new google.visualization.ChartWrapper({chartType:'ColumnChart', containerId:'chart_operacao', options:{title:'Preço Médio por Operação', height:400, legend:'none', colors:['#3498db']}});
  const chartOperacaoTipo = new google.visualization.ChartWrapper({chartType:'BarChart', containerId:'chart_operacao_tipo', options:{title:'Operação + Tipo x Preço', height:400, colors:['#2ecc71','#9b59b6']}});
  const chartScatter = new google.visualization.ChartWrapper({chartType:'ScatterChart', containerId:'chart_scatter', options:{title:'Preço x Área', height:400, hAxis:{title:'Área (m²)'}, vAxis:{title:'Preço (R$)'}, colors:['#e74c3c']}});
  const chartTopBairros = new google.visualization.ChartWrapper({chartType:'BarChart', containerId:'chart_top_bairros', options:{title:'Top 10 Bairros mais caros', height:400, colors:['#f39c12'], legend:'none']}});
  const chartHeatmap = new google.visualization.ChartWrapper({chartType:'Table', containerId:'chart_heatmap', options:{showRowNumber:false, width:'100%', height:400, allowHtml:true}});

  // Bind
  dashboard.bind([operationFilter,typeFilter,cityFilter],[chartBairro, chartOperacao, chartOperacaoTipo, chartScatter, chartTopBairros, chartHeatmap]);
  dashboard.draw(data);

  // Atualiza gráficos agregados e heatmap após filtros
  function updateAggregates() {
    const viewBairro = aggregateDataView(3); // Bairro
    chartBairro.setDataTable(viewBairro);

    const viewOperacao = aggregateDataView(0); // Operação
    chartOperacao.setDataTable(viewOperacao);

    // Scatter
    const scatterView = new google.visualization.DataView(data);
    scatterView.setRows(scatterView.getFilteredRows([{column:0,value:operationFilter.getState().selectedValues},{column:1,value:typeFilter.getState().selectedValues},{column:2,value:cityFilter.getState().selectedValues}]));
    chartScatter.setDataTable(scatterView);

    // Top 10 bairros
    const rows = [];
    for(let i=0;i<viewBairro.getNumberOfRows();i++){
      rows.push([viewBairro.getValue(i,0), viewBairro.getValue(i,1)]);
    }
    rows.sort((a,b)=>b[1]-a[1]);
    const top10 = new google.visualization.DataTable();
    top10.addColumn('string','Bairro');
    top10.addColumn('number','Preço Médio');
    rows.slice(0,10).forEach(r=>top10.addRow(r));
    chartTopBairros.setDataTable(top10);

    // Heatmap gradiente
    const heatData = new google.visualization.DataTable();
    heatData.addColumn('string','Cidade');
    heatData.addColumn('string','Tipo');
    heatData.addColumn('number','Preço Médio');
    heatData.addColumn({type:'string', role:'style'});

    const heatMap = {};
    for(let i=0;i<data.getNumberOfRows();i++){
      const cidade = data.getValue(i,2);
      const tipo = data.getValue(i,1);
      const preco = data.getValue(i,4);
      if(!heatMap[cidade]) heatMap[cidade]={};
      if(!heatMap[cidade][tipo]) heatMap[cidade][tipo]=[];
      heatMap[cidade][tipo].push(preco);
    }

    // Calcula min/max
    let allVals=[];
    Object.values(heatMap).forEach(t=>Object.values(t).forEach(arr=>allVals.push(...arr)));
    const minVal = Math.min(...allVals);
    const maxVal = Math.max(...allVals);

    Object.keys(heatMap).forEach(cidade=>{
      Object.keys(heatMap[cidade]).forEach(tipo=>{
        const vals = heatMap[cidade][tipo];
        const avg = vals.reduce((a,b)=>a+b,0)/vals.length;
        const ratio = (avg-minVal)/(maxVal-minVal||1);
        const r = Math.round(255*ratio);
        const g = Math.round(255*(1-ratio));
        const b = 0;
        const color = `background-color: rgb(${r},${g},${b})`;
        heatData.addRow([cidade,tipo,avg,color]);
      });
    });
    chartHeatmap.setDataTable(heatData);
  }

  google.visualization.events.addListener(dashboard,'ready',updateAggregates);
  google.visualization.events.addListener(operationFilter,'statechange',updateAggregates);
  google.visualization.events.addListener(typeFilter,'statechange',updateAggregates);
  google.visualization.events.addListener(cityFilter,'statechange',updateAggregates);
}
</script>
</head>
<body>
<h2>Dashboard Avançado - Imóveis Dinâmico</h2>
<div id="filters">
    <div id="filter_operacao"></div>
    <div id="filter_tipo"></div>
    <div id="filter_cidade"></div>
</div>
<div class="wrapper" id="dashboard">
    <div class="chart-container" id="chart_bairro"></div>
    <div class="chart-container" id="chart_operacao"></div>
    <div class="chart-container" id="chart_operacao_tipo"></div>
    <div class="chart-container" id="chart_scatter"></div>
    <div class="chart-container" id="chart_top_bairros"></div>
    <div class="chart-container" id="chart_heatmap"></div>
</div>
</body>
</html>
