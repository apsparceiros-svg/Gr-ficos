<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Imobiliário Profissional</title>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<style>
    body { font-family: 'Roboto', sans-serif; margin: 0; background: #f4f4f9; color: #333; }
    h1 { text-align: center; color: #8e44ad; margin-top: 20px; }
    .filters { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin: 20px 0; }
    .filters select, .filters input { padding: 8px; border-radius: 6px; border: 1px solid #ccc; }
    .chart-container { width: 100%; max-width: 1000px; margin: 0 auto 50px; }
    .chart { width: 100%; height: 500px; margin: 20px 0; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); background: #fff; }
    @media(max-width: 768px){ .chart { height: 400px; } }
</style>
</head>
<body>

<h1>Dashboard Imobiliário Profissional</h1>

<div class="filters">
    <select id="filterOperacao"><option value="">Todas Operações</option></select>
    <select id="filterTipo"><option value="">Todos Tipos</option></select>
    <select id="filterCidade"><option value="">Todas Cidades</option></select>
    <select id="filterBairro"><option value="">Todos Bairros</option></select>
    <input type="number" id="filterPrecoMin" placeholder="Preço Min R$">
    <input type="number" id="filterPrecoMax" placeholder="Preço Max R$">
</div>

<div class="chart-container">
    <div id="chartBairro" class="chart"></div>
    <div id="chartCidade" class="chart"></div>
    <div id="chartTipo" class="chart"></div>
    <div id="chartOperacao" class="chart"></div>
    <div id="chartOperacaoTipo" class="chart"></div>
    <div id="chartScatter" class="chart"></div>
</div>

<script>
google.charts.load('current', {packages:['corechart','bar','controls']});
google.charts.setOnLoadCallback(init);

const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQP-T1jc4Rpdigxqpkf7cL0MYiA8IESg1ATBwVdT7gTTPaMll_LGuwj0zOfbeEIO8Qv3DOZsK6eNBrZ/pub?gid=11391417&single=true&output=csv';
let rawData = [];

function init(){
    Papa.parse(csvUrl, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(results){
            rawData = results.data;
            populateFilters();
            drawAllCharts();
        }
    });

    document.querySelectorAll('.filters select, .filters input').forEach(el=>{
        el.addEventListener('change', drawAllCharts);
    });
}

function getFilteredData(){
    let filtered = rawData.slice();
    const op = document.getElementById('filterOperacao').value;
    const tipo = document.getElementById('filterTipo').value;
    const cidade = document.getElementById('filterCidade').value;
    const bairro = document.getElementById('filterBairro').value;
    const precoMin = parseFloat(document.getElementById('filterPrecoMin').value) || 0;
    const precoMax = parseFloat(document.getElementById('filterPrecoMax').value) || Infinity;

    return filtered.filter(row => {
        const preco = parseFloat(row.preco.replace(',','')) || 0;
        return (!op || row.operacao === op)
            && (!tipo || row.tipo === tipo)
            && (!cidade || row.cidade === cidade)
            && (!bairro || row.bairro === bairro)
            && preco >= precoMin && preco <= precoMax;
    });
}

function populateFilters(){
    const ops = new Set(); const tipos = new Set(); const cidades = new Set(); const bairros = new Set();
    rawData.forEach(r => { ops.add(r.operacao); tipos.add(r.tipo); cidades.add(r.cidade); bairros.add(r.bairro); });
    fillSelect('filterOperacao', ops);
    fillSelect('filterTipo', tipos);
    fillSelect('filterCidade', cidades);
    fillSelect('filterBairro', bairros);
}

function fillSelect(id, items){
    const sel = document.getElementById(id);
    Array.from(items).sort().forEach(i=>{
        const opt = document.createElement('option'); opt.value=i; opt.textContent=i; sel.appendChild(opt);
    });
}

function drawAllCharts(){
    const data = getFilteredData();

    drawColumnChart('chartBairro', data, 'bairro', 'Preço');
    drawColumnChart('chartCidade', data, 'cidade', 'Preço');
    drawColumnChart('chartTipo', data, 'tipo', 'Preço');
    drawColumnChart('chartOperacao', data, 'operacao', 'Preço');
    drawComboChart('chartOperacaoTipo', data);
    drawScatterChart('chartScatter', data);
}

function aggregate(data, key){
    const map = {};
    data.forEach(r=>{
        const k = r[key];
        const p = parseFloat(r.preco.replace(',','')) || 0;
        if(!map[k]) map[k]=[]; map[k].push(p);
    });
    return Object.keys(map).map(k=>{
        const arr = map[k]; const avg = arr.reduce((a,b)=>a+b,0)/arr.length;
        return [k, avg];
    });
}

function drawColumnChart(containerId, data, key, valueLabel){
    const agg = aggregate(data, key);
    const chartData = new google.visualization.DataTable();
    chartData.addColumn('string', key);
    chartData.addColumn('number', valueLabel);
    chartData.addRows(agg);

    const options = {
        title: `Preço Médio por ${key.charAt(0).toUpperCase()+key.slice(1)}`,
        is3D:true,
        backgroundColor:'#fff',
        colors:['#e67e22','#3498db','#2ecc71','#9b59b6'],
        hAxis:{title:key}, vAxis:{title:'Preço Médio (R$)'}
    };

    const chart = new google.visualization.ColumnChart(document.getElementById(containerId));
    chart.draw(chartData, options);
}

function drawComboChart(containerId, data){
    const map = {};
    data.forEach(r=>{
        const k = `${r.operacao} - ${r.tipo}`;
        const p = parseFloat(r.preco.replace(',','')) || 0;
        if(!map[k]) map[k]=[]; map[k].push(p);
    });
    const rows = Object.keys(map).map(k=>{
        const arr=map[k]; const avg = arr.reduce((a,b)=>a+b,0)/arr.length; return [k, avg];
    });

    const chartData = new google.visualization.DataTable();
    chartData.addColumn('string','Operação + Tipo');
    chartData.addColumn('number','Preço Médio');
    chartData.addRows(rows);

    const options = {
        title:'Preço Médio por Operação + Tipo',
        is3D:true,
        backgroundColor:'#fff',
        colors:['#2ecc71','#9b59b6','#e67e22','#3498db'],
        hAxis:{title:'Operação + Tipo'}, vAxis:{title:'Preço Médio (R$)'}
    };

    const chart = new google.visualization.BarChart(document.getElementById(containerId));
    chart.draw(chartData, options);
}

function drawScatterChart(containerId, data){
    const chartData = new google.visualization.DataTable();
    chartData.addColumn('number','Área (m²)');
    chartData.addColumn('number','Preço (R$)');
    chartData.addColumn({type:'string', role:'tooltip'});
    data.forEach(r=>{
        const area = parseFloat(r.area.replace(',','')) || 0;
        const preco = parseFloat(r.preco.replace(',','')) || 0;
        const tip = `${r.titulo}\n${r.operacao} - ${r.tipo}\n${r.bairro} / ${r.cidade}\nR$ ${preco.toLocaleString()}`;
        chartData.addRow([area, preco, tip]);
    });

    const options = {
        title:'Preço x Área',
        hAxis:{title:'Área (m²)'},
        vAxis:{title:'Preço (R$)'},
        colors:['#3498db'],
        backgroundColor:'#fff'
    };

    const chart = new google.visualization.ScatterChart(document.getElementById(containerId));
    chart.draw(chartData, options);
}
</script>
</body>
</html>
