<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Premium - Imóveis</title>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<style>
body { font-family: Arial, sans-serif; background:#f4f4f9; margin:0; padding:20px; }
h1 { text-align:center; color:#4a148c; margin-bottom:10px; }
.summary { display:flex; flex-wrap:wrap; justify-content:center; gap:20px; margin-bottom:30px; }
.summary div { background:#fff; padding:15px; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.1); min-width:150px; text-align:center; }
.filters { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-bottom:20px; }
.filters select, .filters input, .filters button { padding:5px 10px; border-radius:5px; border:1px solid #ccc; cursor:pointer; }
.charts-wrapper { display:grid; grid-template-columns: repeat(2,1fr); gap:20px; }
@media(max-width:768px){ .charts-wrapper{ grid-template-columns:1fr; } }
.chart-container { background:#fff; padding:15px; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.1); min-height:400px; }
</style>
</head>
<body>

<h1>Dashboard Premium - Imóveis</h1>

<div class="summary" id="summary">
  <div id="totalImoveis">Total Imóveis: 0</div>
  <div id="precoMedio">Preço Médio Geral: R$ 0</div>
  <div id="precoMax">Preço Máx: R$ 0</div>
  <div id="precoMin">Preço Mín: R$ 0</div>
</div>

<div class="filters">
  <select id="filterOperacao"><option value="">Todas Operações</option></select>
  <select id="filterTipo"><option value="">Todos Tipos</option></select>
  <select id="filterCidade"><option value="">Todas Cidades</option></select>
  <select id="filterBairro"><option value="">Todos Bairros</option></select>
  <label>Preço Máx:</label><input type="range" id="filterPreco" min="0" max="5000000" step="10000">
  <label>Área Máx:</label><input type="range" id="filterArea" min="0" max="1000" step="10">
  <button id="resetFilters">Resetar Filtros</button>
</div>

<div class="charts-wrapper" id="charts-wrapper">
  <div class="chart-container" id="chart0"></div>
  <div class="chart-container" id="chart1"></div>
  <div class="chart-container" id="chart2"></div>
  <div class="chart-container" id="chart3"></div>
  <div class="chart-container" id="chart4"></div>
  <div class="chart-container" id="chart5"></div>
  <div class="chart-container" id="chart6"></div>
</div>

<script>
google.charts.load('current', {'packages':['corechart','bar']});
google.charts.setOnLoadCallback(loadData);

const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQP-T1jc4Rpdigxqpkf7cL0MYiA8IESg1ATBwVdT7gTTPaMll_LGuwj0zOfbeEIO8Qv3DOZsK6eNBrZ/pub?gid=11391417&single=true&output=csv";
let allData = [], filteredData = [];

function loadData() {
  Papa.parse(csvUrl, { download:true, header:true, dynamicTyping:true, complete: function(results){
    allData = results.data.filter(r=>r.preco && r.preco>0);
    filteredData = allData;
    populateFilters(allData);
    updateSummary(filteredData);
    drawAllCharts(filteredData);
  }});
}

function populateFilters(data){
  const getUnique = key => [...new Set(data.map(d=>d[key]).filter(Boolean))].sort();
  const sets = {Operacao:'operacao', Tipo:'tipo', Cidade:'cidade', Bairro:'bairro'};
  for(const id in sets){
    const sel = document.getElementById('filter'+id);
    getUnique(sets[id]).forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
    sel.addEventListener('change', updateCharts);
  }
  document.getElementById('filterPreco').addEventListener('input',updateCharts);
  document.getElementById('filterArea').addEventListener('input',updateCharts);
  document.getElementById('resetFilters').addEventListener('click',()=>{
    document.querySelectorAll('.filters select').forEach(s=>s.value='');
    document.getElementById('filterPreco').value=5000000;
    document.getElementById('filterArea').value=1000;
    filteredData = allData;
    updateSummary(filteredData);
    drawAllCharts(filteredData);
  });
}

function updateCharts(){
  // Primeiro recalculamos os filtros de dropdown dinamicamente
  const filters = {
    operacao: document.getElementById('filterOperacao').value,
    tipo: document.getElementById('filterTipo').value,
    cidade: document.getElementById('filterCidade').value,
    bairro: document.getElementById('filterBairro').value,
    precoMax: parseFloat(document.getElementById('filterPreco').value),
    areaMax: parseFloat(document.getElementById('filterArea').value)
  };

  filteredData = allData.filter(row => {
    return (!filters.operacao || row.operacao === filters.operacao) &&
           (!filters.tipo || row.tipo === filters.tipo) &&
           (!filters.cidade || row.cidade === filters.cidade) &&
           (!filters.bairro || row.bairro === filters.bairro) &&
           (!filters.precoMax || row.preco <= filters.precoMax) &&
           (!filters.areaMax || row.area <= filters.areaMax);
  });

  updateSummary(filteredData);
  drawAllCharts(filteredData);
}

function updateSummary(data){
  const total = data.length;
  const precoMed = total>0 ? (data.reduce((s,d)=>s+d.preco,0)/total).toFixed(2) : 0;
  const precoMax = total>0 ? Math.max(...data.map(d=>d.preco)) : 0;
  const precoMin = total>0 ? Math.min(...data.map(d=>d.preco)) : 0;
  document.getElementById('totalImoveis').textContent = `Total Imóveis: ${total}`;
  document.getElementById('precoMedio').textContent = `Preço Médio Geral: R$ ${precoMed}`;
  document.getElementById('precoMax').textContent = `Preço Máx: R$ ${precoMax}`;
  document.getElementById('precoMin').textContent = `Preço Mín: R$ ${precoMin}`;
}

function groupBy(arr, keys){ return arr.reduce((acc,item)=>{
  const k = keys.map(key=>item[key]||"").join(" | ");
  acc[k]=acc[k]||[]; acc[k].push(item); return acc;
},{})}

function avg(arr){ return arr.reduce((s,i)=>s+i.preco,0)/arr.length }

function drawAllCharts(data){
  const configs = [
    {keys:['operacao'], title:'Preço Médio por Operação', div:'chart0', colors:['#e67e22','#f39c12','#d35400','#e74c3c']},
    {keys:['tipo'], title:'Preço Médio por Tipo', div:'chart1', colors:['#3498db','#2980b9','#1abc9c','#16a085']},
    {keys:['cidade'], title:'Preço Médio por Cidade', div:'chart2', colors:['#2ecc71','#27ae60','#1abc9c','#16a085']},
    {keys:['bairro'], title:'Preço Médio por Bairro', div:'chart3', colors:['#8e44ad','#9b59b6','#71368a','#9b59b6']},
    {keys:['operacao','tipo'], title:'Preço Médio por Operação/Tipo', div:'chart4', colors:['#f39c12','#d35400','#e67e22','#e74c3c']},
    {keys:['cidade','bairro'], title:'Preço Médio por Cidade/Bairro', div:'chart5', colors:['#16a085','#1abc9c','#27ae60','#2ecc71']},
    {keys:['area','preco'], title:'Dispersão Preço x Área', div:'chart6', type:'scatter', color:'#e67e22'}
  ];

  configs.forEach(c=>{
    const div = document.getElementById(c.div);
    if(c.type==='scatter'){
      const dt=new google.visualization.DataTable();
      dt.addColumn('number','Área'); dt.addColumn('number','Preço'); dt.addColumn({type:'string',role:'tooltip', 'p': {'html': true}});
      data.slice(0,200).forEach(d=>{
        const tooltip = `<div style="padding:5px;"><b>${d.titulo}</b><br>${d.operacao} | ${d.tipo}<br>${d.cidade} - ${d.bairro}<br>Área: ${d.area}m²<br>Preço: R$ ${d.preco}</div>`;
        dt.addRow([d.area||0,d.preco, tooltip]);
      });
      const chart = new google.visualization.ScatterChart(div);
      chart.draw(dt,{
        title:c.title, hAxis:{title:'Área (m²)'}, vAxis:{title:'Preço (R$)'},
        tooltip:{isHtml:true}, colors:[c.color], legend:'none', animation:{duration:500,easing:'out'}
      });
      return;
    }

    const grouped = Object.entries(groupBy(data, c.keys))
      .map(([k,v]) => [k, avg(v)])
      .sort((a,b)=>b[1]-a[1]); // ordenar decrescente

    const dt = new google.visualization.DataTable();
    dt.addColumn('string', c.keys.join(' | '));
    dt.addColumn('number','Preço Médio');
    grouped.forEach(r=>dt.addRow(r));

    const chart = new google.visualization.ColumnChart(div);
    chart.draw(dt,{
      title:c.title, is3D:true, vAxis:{title:'Preço (R$)'}, hAxis:{title:c.keys.join(' | ')},
      colors:c.colors, animation:{duration:600,easing:'out'}, bar:{groupWidth:'60%'}, tooltip:{isHtml:true}
    });

    google.visualization.events.addListener(chart,'select',()=>{
      const sel = chart.getSelection();
      if(sel.length>0){
        const label = dt.getValue(sel[0].row,0);
        const values = label.split(' | ');
        const filters = {};
        c.keys.forEach((k,i)=>filters[k.toLowerCase()]=values[i]);
        filteredData = filterData(filters);
        updateSummary(filteredData);
        drawAllCharts(filteredData);
      }
    });
  });
}

function updateCharts(){
  filteredData = filterData();
  updateSummary(filteredData);
  drawAllCharts(filteredData);
}
</script>

</body>
</html>
