<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Profissional de Imóveis</title>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<style>
body { font-family: Arial, sans-serif; background:#f4f4f9; margin:0; padding:20px; }
h2 { text-align:center; margin-bottom:20px; color:#4a148c; }
.filters { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-bottom:20px; }
.filters select, .filters input { padding:5px 10px; border-radius:5px; border:1px solid #ccc; }
.charts-wrapper { display:grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap:20px; }
.chart-container { background:#fff; padding:15px; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.1); }
</style>
</head>
<body>
<h2>Dashboard Profissional de Imóveis</h2>

<div class="filters">
  <select id="filterOperacao"><option value="">Todas Operações</option></select>
  <select id="filterTipo"><option value="">Todos Tipos</option></select>
  <select id="filterCidade"><option value="">Todas Cidades</option></select>
  <select id="filterBairro"><option value="">Todos Bairros</option></select>
  <label>Preço Máx:</label><input type="range" id="filterPreco" min="0" max="2000000" step="10000">
  <label>Área Máx:</label><input type="range" id="filterArea" min="0" max="1000" step="10">
</div>

<div class="charts-wrapper" id="charts-wrapper"></div>

<script>
google.charts.load('current', {'packages':['corechart','bar']});
google.charts.setOnLoadCallback(loadData);

const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQP-T1jc4Rpdigxqpkf7cL0MYiA8IESg1ATBwVdT7gTTPaMll_LGuwj0zOfbeEIO8Qv3DOZsK6eNBrZ/pub?gid=11391417&single=true&output=csv";
let allData = [];

function loadData() {
  Papa.parse(csvUrl, { download:true, header:true, dynamicTyping:true, complete: function(results){
    allData = results.data.filter(r=>r.preco && r.preco>0);
    populateFilters(allData);
    drawAllCharts(allData);
  }});
}

function populateFilters(data){
  const getUnique = key => [...new Set(data.map(d=>d[key]).filter(Boolean))].sort();
  const sets = {Operacao:'operacao', Tipo:'tipo', Cidade:'cidade', Bairro:'bairro'};
  for(const id in sets){
    const sel = document.getElementById('filter'+id);
    getUnique(sets[id]).forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
    sel.addEventListener('change', updateCharts);
  }
  document.getElementById('filterPreco').addEventListener('input',updateCharts);
  document.getElementById('filterArea').addEventListener('input',updateCharts);
}

function filterData(){
  const filters = {
    operacao: document.getElementById('filterOperacao').value,
    tipo: document.getElementById('filterTipo').value,
    cidade: document.getElementById('filterCidade').value,
    bairro: document.getElementById('filterBairro').value,
    precoMax: parseFloat(document.getElementById('filterPreco').value),
    areaMax: parseFloat(document.getElementById('filterArea').value)
  };
  return allData.filter(row =>
    (!filters.operacao || row.operacao===filters.operacao) &&
    (!filters.tipo || row.tipo===filters.tipo) &&
    (!filters.cidade || row.cidade===filters.cidade) &&
    (!filters.bairro || row.bairro===filters.bairro) &&
    (!filters.precoMax || row.preco <= filters.precoMax) &&
    (!filters.areaMax || row.area <= filters.areaMax)
  );
}

function groupBy(arr, keys){ return arr.reduce((acc,item)=>{
  const k = keys.map(key=>item[key]||"").join(" | ");
  acc[k]=acc[k]||[]; acc[k].push(item); return acc;
},{})}

function avg(arr){ return arr.reduce((sum,i)=>sum+i.preco,0)/arr.length }

function drawAllCharts(data){
  document.getElementById('charts-wrapper').innerHTML='';
  
  const charts = [
    {keys:['operacao'], title:'Preço Médio por Operação', type:'col', color:'#e67e22'},
    {keys:['tipo'], title:'Preço Médio por Tipo', type:'col', color:'#3498db'},
    {keys:['cidade'], title:'Preço Médio por Cidade', type:'col', color:'#2ecc71'},
    {keys:['bairro'], title:'Preço Médio por Bairro', type:'col', color:'#8e44ad'},
    {keys:['operacao','tipo'], title:'Operação + Tipo', type:'col', color:'#f39c12'},
    {keys:['cidade','bairro'], title:'Cidade + Bairro', type:'col', color:'#16a085'},
    {keys:['tipo','cidade'], title:'Tipo + Cidade', type:'col', color:'#9b59b6'},
    {keys:['operacao','cidade'], title:'Operação + Cidade', type:'col', color:'#d35400'},
    {keys:['tipo','preco'], title:'Dispersão Preço x Área', type:'scatter'},
    {keys:['preco'], title:'Top 10 Imóveis Mais Caros', type:'top10'},
    {keys:['cidade'], title:'Heatmap Preço Médio por Cidade', type:'heatmap'}
  ];

  charts.forEach((c,i)=>{
    const div=document.createElement('div'); div.className='chart-container'; div.id='chart'+i;
    document.getElementById('charts-wrapper').appendChild(div);

    if(c.type==='scatter'){
      const dt=new google.visualization.DataTable();
      dt.addColumn('number','Área'); dt.addColumn('number','Preço'); dt.addColumn({type:'string',role:'tooltip'});
      data.forEach(d=>dt.addRow([d.area||0,d.preco,`${d.titulo}\nÁrea: ${d.area}m²\nPreço: R$${d.preco}`]));
      new google.visualization.ScatterChart(div).draw(dt,{
        title:c.title,hAxis:{title:'Área (m²)'},vAxis:{title:'Preço (R$)'},colors:['#e67e22'],legend:'none',animation:{startup:true,duration:800}
      });
    } else if(c.type==='top10'){
      const sorted=[...data].sort((a,b)=>b.preco-a.preco).slice(0,10);
      const dt=new google.visualization.DataTable();
      dt.addColumn('string','Título'); dt.addColumn('number','Preço'); dt.addColumn({type:'string',role:'tooltip'});
      sorted.forEach(d=>dt.addRow([d.titulo,d.preco,`${d.titulo}\nPreço: R$${d.preco}`]));
      new google.visualization.BarChart(div).draw(dt,{title:c.title,hAxis:{title:'Preço (R$)'},vAxis:{title:'Título'},is3D:true,colors:['#d35400'],legend:'none',animation:{startup:true,duration:800}});
    } else if(c.type==='heatmap'){
      const grouped=groupBy(data,c.keys);
      const dt=new google.visualization.DataTable();
      dt.addColumn('string',c.keys[0]); dt.addColumn('number','Preço Médio'); dt.addColumn({type:'string',role:'tooltip'});
      for(const key in grouped){
        const a=avg(grouped[key]);
        dt.addRow([key,a,`${key}\nPreço Médio: R$${a.toFixed(2)}`]);
      }
      new google.visualization.ColumnChart(div).draw(dt,{title:c.title,hAxis:{title:c.keys.join(' + ')},vAxis:{title:'Preço Médio (R$)'},colors:['#ff6f61'],legend:'none',is3D:true,animation:{startup:true,duration:800}});
    } else {
      const grouped=groupBy(data,c.keys);
      const dt=new google.visualization.DataTable();
      dt.addColumn('string',c.keys.join(' + ')); dt.addColumn('number','Preço Médio'); dt.addColumn({type:'string',role:'tooltip'});
      for(const key in grouped){
        const a=avg(grouped[key]);
        dt.addRow([key,a,`${key}\nPreço Médio: R$${a.toFixed(2)}`]);
      }
      new google.visualization.ColumnChart(div).draw(dt,{title:c.title,is3D:true,hAxis:{title:c.keys.join(' + ')},vAxis:{title:'Preço Médio (R$)'},colors:[c.color],legend:'none',backgroundColor:'#f4f4f9',animation:{startup:true,duration:800}});
    }
  });
}

function updateCharts(){ drawAllCharts(filterData()); }
</script>
</body>
</html>
