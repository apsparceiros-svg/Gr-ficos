<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Avançado - Imóveis</title>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
body { font-family:'Roboto', sans-serif; background:#f4f4f9; margin:0; padding:0; color:#333;}
h2 { text-align:center; color:#8e44ad; margin:20px 0;}
.wrapper { display:flex; flex-wrap:wrap; justify-content:center; gap:30px; padding:20px;}
.chart-container { background:#fff; border-radius:12px; padding:15px; box-shadow:0 4px 12px rgba(0,0,0,0.1); max-width:600px; flex:1 1 500px;}
#filters { display:flex; gap:20px; justify-content:center; flex-wrap:wrap; margin-bottom:20px;}
select { padding:8px 12px; border-radius:6px; border:1px solid #d3b28d; background:#fff;}
</style>
<script>
google.charts.load('current', {packages:['corechart','controls','bar','table']});
google.charts.setOnLoadCallback(loadData);

const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQP-T1jc4Rpdigxqpkf7cL0MYiA8IESg1ATBwVdT7gTTPaMll_LGuwj0zOfbeEIO8Qv3DOZsK6eNBrZ/pub?gid=11391417&single=true&output=csv";

let data; // tabela base
let operationFilter, typeFilter, cityFilter;
let chartBairro, chartOperacao, chartOperacaoTipo, chartScatter, chartTopBairros, chartHeatmap;

function loadData(){
    Papa.parse(csvUrl, {
        download: true,
        header: true,
        complete: function(results){
            const rows = results.data.filter(r => r.preco);
            data = new google.visualization.DataTable();
            data.addColumn('string','Operação');
            data.addColumn('string','Tipo');
            data.addColumn('string','Cidade');
            data.addColumn('string','Bairro');
            data.addColumn('number','Preço');
            data.addColumn('number','Área');

            rows.forEach(r=>{
                data.addRow([
                    r.operacao||"",
                    r.tipo||"",
                    r.cidade||"",
                    r.bairro||"",
                    Number(r.preco)||0,
                    Number(r.area)||0
                ]);
            });

            drawDashboard();
        }
    });
}

function drawDashboard() {
    // Cria filtros
    operationFilter = new google.visualization.ControlWrapper({
        controlType:'CategoryFilter',
        containerId:'filter_operacao',
        options:{filterColumnLabel:'Operação', ui:{allowTyping:false, allowMultiple:true}}
    });
    typeFilter = new google.visualization.ControlWrapper({
        controlType:'CategoryFilter',
        containerId:'filter_tipo',
        options:{filterColumnLabel:'Tipo', ui:{allowTyping:false, allowMultiple:true}}
    });
    cityFilter = new google.visualization.ControlWrapper({
        controlType:'CategoryFilter',
        containerId:'filter_cidade',
        options:{filterColumnLabel:'Cidade', ui:{allowTyping:false, allowMultiple:true}}
    });

    // Cria gráficos
    chartBairro = new google.visualization.ChartWrapper({ chartType:'ColumnChart', containerId:'chart_bairro', options:{title:'Preço Médio por Bairro', height:400, legend:'none', colors:['#e67e22']}});
    chartOperacao = new google.visualization.ChartWrapper({ chartType:'ColumnChart', containerId:'chart_operacao', options:{title:'Preço Médio por Operação', height:400, legend:'none', colors:['#3498db']}});
    chartOperacaoTipo = new google.visualization.ChartWrapper({ chartType:'BarChart', containerId:'chart_operacao_tipo', options:{title:'Operação + Tipo x Preço', height:400, colors:['#2ecc71','#9b59b6']}});
    chartScatter = new google.visualization.ChartWrapper({ chartType:'ScatterChart', containerId:'chart_scatter', options:{title:'Preço x Área', height:400, hAxis:{title:'Área (m²)'}, vAxis:{title:'Preço (R$)'}, colors:['#e74c3c']}});
    chartTopBairros = new google.visualization.ChartWrapper({ chartType:'BarChart', containerId:'chart_top_bairros', options:{title:'Top 10 Bairros mais caros', height:400, colors:['#f39c12'], legend:'none'}});
    chartHeatmap = new google.visualization.ChartWrapper({ chartType:'Table', containerId:'chart_heatmap', options:{showRowNumber:false, width:'100%', height:400, allowHtml:true}});

    // Atualiza gráficos com base nos filtros
    function updateCharts() {
        const opState = operationFilter.getState().selectedValues;
        const tipoState = typeFilter.getState().selectedValues;
        const cidadeState = cityFilter.getState().selectedValues;

        // Filtra linhas
        const filteredRows = [];
        for(let i=0;i<data.getNumberOfRows();i++){
            const op = data.getValue(i,0);
            const tipo = data.getValue(i,1);
            const cidade = data.getValue(i,2);
            if((opState.length===0 || opState.includes(op)) &&
               (tipoState.length===0 || tipoState.includes(tipo)) &&
               (cidadeState.length===0 || cidadeState.includes(cidade))){
                filteredRows.push({
                    operacao: op,
                    tipo: tipo,
                    cidade: cidade,
                    bairro: data.getValue(i,3),
                    preco: data.getValue(i,4),
                    area: data.getValue(i,5)
                });
            }
        }

        const agregateBy = (arr,keyCol,valueCol)=>{
            const map = {};
            arr.forEach(r=>{
                const key = r[keyCol]||"";
                if(!map[key]) map[key]=[];
                map[key].push(r[valueCol]||0);
            });
            const result = [];
            Object.keys(map).forEach(k=>{
                const vals = map[k];
                const media = vals.reduce((a,b)=>a+b,0)/vals.length;
                result.push([k,media]);
            });
            return result;
        };

        // Bairro
        const bairroData = new google.visualization.DataTable();
        bairroData.addColumn('string','Bairro');
        bairroData.addColumn('number','Preço Médio');
        agregateBy(filteredRows,'bairro','preco').forEach(r=>bairroData.addRow(r));
        chartBairro.setDataTable(bairroData);

        // Operação
        const operacaoData = new google.visualization.DataTable();
        operacaoData.addColumn('string','Operação');
        operacaoData.addColumn('number','Preço Médio');
        agregateBy(filteredRows,'operacao','preco').forEach(r=>operacaoData.addRow(r));
        chartOperacao.setDataTable(operacaoData);

        // Operação + Tipo
        const opTipoMap = {};
        filteredRows.forEach(r=>{
            const key = r.operacao+'|'+r.tipo;
            if(!opTipoMap[key]) opTipoMap[key]=[];
            opTipoMap[key].push(r.preco||0);
        });
        const opTipoData = new google.visualization.DataTable();
        opTipoData.addColumn('string','Operação');
        opTipoData.addColumn('string','Tipo');
        opTipoData.addColumn('number','Preço Médio');
        Object.keys(opTipoMap).forEach(k=>{
            const [op,tipo] = k.split('|');
            const vals = opTipoMap[k];
            const media = vals.reduce((a,b)=>a+b,0)/vals.length;
            opTipoData.addRow([op,tipo,media]);
        });
        chartOperacaoTipo.setDataTable(opTipoData);

        // Scatter
        const scatterData = new google.visualization.DataTable();
        scatterData.addColumn('number','Área');
        scatterData.addColumn('number','Preço');
        filteredRows.forEach(r=>scatterData.addRow([r.area,r.preco]));
        chartScatter.setDataTable(scatterData);

        // Top 10 bairros
        const topBairros = agregateBy(filteredRows,'bairro','preco')
            .sort((a,b)=>b[1]-a[1])
            .slice(0,10);
        const topData = new google.visualization.DataTable();
        topData.addColumn('string','Bairro');
        topData.addColumn('number','Preço Médio');
        topBairros.forEach(r=>topData.addRow(r));
        chartTopBairros.setDataTable(topData);

        // Heatmap
        const heatMap = {};
        filteredRows.forEach(r=>{
            const key = r.cidade+'|'+r.tipo;
            if(!heatMap[key]) heatMap[key]=[];
            heatMap[key].push(r.preco||0);
        });
        const heatData = new google.visualization.DataTable();
        heatData.addColumn('string','Cidade');
        heatData.addColumn('string','Tipo');
        heatData.addColumn('number','Preço Médio');
        heatData.addColumn({type:'string', role:'style'});
        Object.keys(heatMap).forEach(k=>{
            const [cidade,tipo] = k.split('|');
            const vals = heatMap[k];
            const media = vals.reduce((a,b)=>a+b,0)/vals.length;
            let cor='#2ecc71';
            if(media>500000) cor='#e74c3c';
            else if(media>300000) cor='#f1c40f';
            heatData.addRow([cidade,tipo,media,'background-color:'+cor]);
        });
        chartHeatmap.setDataTable(heatData);
    }

    // Eventos de atualização
    google.visualization.events.addListener(operationFilter,'statechange',updateCharts);
    google.visualization.events.addListener(typeFilter,'statechange',updateCharts);
    google.visualization.events.addListener(cityFilter,'statechange',updateCharts);

    // Desenha filtros
    operationFilter.draw();
    typeFilter.draw();
    cityFilter.draw();

    // Inicializa gráficos
    updateCharts();
}
</script>
</head>
<body>
<h2>Dashboard Avançado - Imóveis Dinâmico</h2>
<div id="filters">
    <div id="filter_operacao"></div>
    <div id="filter_tipo"></div>
    <div id="filter_cidade"></div>
</div>
<div class="wrapper" id="dashboard">
    <div class="chart-container" id="chart_bairro"></div>
    <div class="chart-container" id="chart_operacao"></div>
    <div class="chart-container" id="chart_operacao_tipo"></div>
    <div class="chart-container" id="chart_scatter"></div>
    <div class="chart-container" id="chart_top_bairros"></div>
    <div class="chart-container" id="chart_heatmap"></div>
</div>
</body>
</html>
