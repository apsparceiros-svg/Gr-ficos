<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Avançado - Imóveis</title>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
body { font-family:'Roboto', sans-serif; background:#f4f4f9; margin:0; padding:0; color:#333;}
h2 { text-align:center; color:#8e44ad; margin:20px 0;}
.wrapper { display:flex; flex-wrap:wrap; justify-content:center; gap:30px; padding:20px;}
.chart-container { background:#fff; border-radius:12px; padding:15px; box-shadow:0 4px 12px rgba(0,0,0,0.1); max-width:600px; flex:1 1 500px;}
#filters { display:flex; gap:20px; justify-content:center; flex-wrap:wrap; margin-bottom:20px;}
select { padding:8px 12px; border-radius:6px; border:1px solid #d3b28d; background:#fff;}
</style>
<script>
google.charts.load('current', {packages:['corechart','controls','bar','table']});
google.charts.setOnLoadCallback(loadData);

const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQP-T1jc4Rpdigxqpkf7cL0MYiA8IESg1ATBwVdT7gTTPaMll_LGuwj0zOfbeEIO8Qv3DOZsK6eNBrZ/pub?gid=11391417&single=true&output=csv";

function loadData(){
    Papa.parse(csvUrl, {
        download: true,
        header: true,
        complete: function(results){
            const data = results.data.filter(r => r.preco);
            drawDashboard(data);
        }
    });
}

function drawDashboard(rows){
    const data = new google.visualization.DataTable();
    data.addColumn('string','Operação');
    data.addColumn('string','Tipo');
    data.addColumn('string','Cidade');
    data.addColumn('string','Bairro');
    data.addColumn('number','Preço');
    data.addColumn('number','Área');

    rows.forEach(r=>{
        data.addRow([
            r.operacao||"",
            r.tipo||"",
            r.cidade||"",
            r.bairro||"",
            Number(r.preco)||0,
            Number(r.area)||0
        ]);
    });

    const dashboard = new google.visualization.Dashboard(document.getElementById('dashboard'));

    const operationFilter = new google.visualization.ControlWrapper({
        controlType:'CategoryFilter',
        containerId:'filter_operacao',
        options:{filterColumnLabel:'Operação', ui:{allowTyping:false, allowMultiple:true}}
    });

    const typeFilter = new google.visualization.ControlWrapper({
        controlType:'CategoryFilter',
        containerId:'filter_tipo',
        options:{filterColumnLabel:'Tipo', ui:{allowTyping:false, allowMultiple:true}}
    });

    const cityFilter = new google.visualization.ControlWrapper({
        controlType:'CategoryFilter',
        containerId:'filter_cidade',
        options:{filterColumnLabel:'Cidade', ui:{allowTyping:false, allowMultiple:true}}
    });

    // Gráfico Preço Médio por Bairro
    const chartBairro = new google.visualization.ChartWrapper({
        chartType:'ColumnChart',
        containerId:'chart_bairro',
        options:{title:'Preço Médio por Bairro', is3D:true, height:400, legend:'none', colors:['#e67e22'], animation:{duration:800,easing:'out',startup:true}},
        view:{columns:[3,4]}
    });

    // Gráfico Preço Médio por Operação
    const chartOperacao = new google.visualization.ChartWrapper({
        chartType:'ColumnChart',
        containerId:'chart_operacao',
        options:{title:'Preço Médio por Operação', is3D:true, height:400, legend:'none', colors:['#3498db'], animation:{duration:800,easing:'out',startup:true}},
        view:{columns:[0,4]}
    });

    // Gráfico Operação + Tipo
    const chartOperacaoTipo = new google.visualization.ChartWrapper({
        chartType:'BarChart',
        containerId:'chart_operacao_tipo',
        options:{title:'Operação + Tipo x Preço', is3D:true, height:400, colors:['#2ecc71','#9b59b6'], animation:{duration:800,easing:'out',startup:true}},
        view:{columns:[0,1,4]}
    });

    // Scatter Preço x Área
    const chartScatter = new google.visualization.ChartWrapper({
        chartType:'ScatterChart',
        containerId:'chart_scatter',
        options:{title:'Preço x Área', height:400, hAxis:{title:'Área (m²)'}, vAxis:{title:'Preço (R$)'}, colors:['#e74c3c'], animation:{duration:800,easing:'out',startup:true}},
        view:{columns:[5,4]}
    });

    // Top 10 Bairros mais caros
    const chartTopBairros = new google.visualization.ChartWrapper({
        chartType:'BarChart',
        containerId:'chart_top_bairros',
        options:{title:'Top 10 Bairros mais caros', height:400, colors:['#f39c12'], legend:'none', animation:{duration:800,easing:'out',startup:true}},
        view:{columns:[3,4]}
    });

    // Heatmap Preço por Cidade e Tipo (como tabela colorida)
    const chartHeatmap = new google.visualization.ChartWrapper({
        chartType:'Table',
        containerId:'chart_heatmap',
        options:{showRowNumber:false, width:'100%', height:400, allowHtml:true}
    });

    // Criar heatmap manual
    const heatmapData = new google.visualization.DataTable();
    heatmapData.addColumn('string','Cidade');
    heatmapData.addColumn('string','Tipo');
    heatmapData.addColumn('number','Preço Médio');

    const heatMapMap = {};
    rows.forEach(r=>{
        const key = r.cidade+'|'+r.tipo;
        if(!heatMapMap[key]) heatMapMap[key]=[];
        heatMapMap[key].push(Number(r.preco)||0);
    });

    Object.keys(heatMapMap).forEach(k=>{
        const [cidade,tipo]=k.split('|');
        const valores=heatMapMap[k];
        const media=valores.reduce((a,b)=>a+b,0)/valores.length;
        heatmapData.addRow([cidade,tipo,media]);
    });

    // Aplicar cores condicionalmente
    heatmapData.addColumn({type:'string', role:'style'});
    for(let i=0;i<heatmapData.getNumberOfRows();i++){
        const valor = heatmapData.getValue(i,2);
        let cor='#2ecc71';
        if(valor>500000) cor='#e74c3c';
        else if(valor>300000) cor='#f1c40f';
        heatmapData.setValue(i,3,'background-color:'+cor);
    }

    chartHeatmap.setDataTable(heatmapData);

    dashboard.bind([operationFilter,typeFilter,cityFilter],[chartBairro, chartOperacao, chartOperacaoTipo, chartScatter, chartTopBairros, chartHeatmap]);
    dashboard.draw(data);
}
</script>
</head>
<body>
<h2>Dashboard Avançado - Imóveis</h2>
<div id="filters">
    <div id="filter_operacao"></div>
    <div id="filter_tipo"></div>
    <div id="filter_cidade"></div>
</div>
<div class="wrapper" id="dashboard">
    <div class="chart-container" id="chart_bairro"></div>
    <div class="chart-container" id="chart_operacao"></div>
    <div class="chart-container" id="chart_operacao_tipo"></div>
    <div class="chart-container" id="chart_scatter"></div>
    <div class="chart-container" id="chart_top_bairros"></div>
    <div class="chart-container" id="chart_heatmap"></div>
</div>
</body>
</html>
