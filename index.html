<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Profissional - Imóveis</title>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
body { font-family: 'Roboto', sans-serif; background: #f4f4f9; color: #333; margin: 0; padding: 20px;}
h1 { text-align:center; color:#8e44ad; margin-bottom: 30px;}
.controls { display:flex; flex-wrap:wrap; gap:15px; justify-content:center; margin-bottom:20px; }
select { padding:8px 12px; border-radius:6px; border:1px solid #ccc;}
.chart-container { width:100%; max-width:1000px; margin: 0 auto 50px; }
#charts { display:flex; flex-direction:column; gap:40px; }
@media(max-width:768px){ .controls { flex-direction:column; align-items:center; } }
</style>
</head>
<body>
<h1>Dashboard Profissional de Imóveis</h1>

<div class="controls">
  <select id="filterCidade"><option value="">Todas as Cidades</option></select>
  <select id="filterBairro"><option value="">Todos os Bairros</option></select>
  <select id="filterTipo"><option value="">Todos os Tipos</option></select>
  <select id="filterOperacao"><option value="">Todas as Operações</option></select>
</div>

<div id="charts">
  <div class="chart-container" id="chartCidade"></div>
  <div class="chart-container" id="chartBairro"></div>
  <div class="chart-container" id="chartTipo"></div>
  <div class="chart-container" id="chartOperacao"></div>
  <div class="chart-container" id="chartOperacaoTipo"></div>
</div>

<script>
google.charts.load('current', {'packages':['corechart', 'bar']});
google.charts.setOnLoadCallback(loadData);

// URL do CSV publicado
const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQP-T1jc4Rpdigxqpkf7cL0MYiA8IESg1ATBwVdT7gTTPaMll_LGuwj0zOfbeEIO8Qv3DOZsK6eNBrZ/pub?gid=11391417&single=true&output=csv';

let rawData = [];

function loadData() {
  Papa.parse(csvUrl, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results){
      rawData = results.data.map(r => ({
        ref: r.ref,
        titulo: r.titulo,
        operacao: r.operacao,
        tipo: r.tipo,
        cidade: r.cidade,
        bairro: r.bairro,
        preco: parseFloat(r.preco.replace(/\./g,'').replace(',','.')) || 0
      }));
      populateFilters();
      drawAllCharts();
    }
  });
}

// Preencher filtros dinamicamente
function populateFilters() {
  const cidades = Array.from(new Set(rawData.map(d=>d.cidade))).sort();
  const bairros = Array.from(new Set(rawData.map(d=>d.bairro))).sort();
  const tipos = Array.from(new Set(rawData.map(d=>d.tipo))).sort();
  const operacoes = Array.from(new Set(rawData.map(d=>d.operacao))).sort();

  const selectC = document.getElementById('filterCidade');
  const selectB = document.getElementById('filterBairro');
  const selectT = document.getElementById('filterTipo');
  const selectO = document.getElementById('filterOperacao');

  cidades.forEach(c=>selectC.innerHTML += `<option value="${c}">${c}</option>`);
  bairros.forEach(b=>selectB.innerHTML += `<option value="${b}">${b}</option>`);
  tipos.forEach(t=>selectT.innerHTML += `<option value="${t}">${t}</option>`);
  operacoes.forEach(o=>selectO.innerHTML += `<option value="${o}">${o}</option>`);

  // Adicionar eventos para filtros
  [selectC, selectB, selectT, selectO].forEach(sel => {
    sel.addEventListener('change', drawAllCharts);
  });
}

// Aplicar filtros
function getFilteredData() {
  const cidade = document.getElementById('filterCidade').value;
  const bairro = document.getElementById('filterBairro').value;
  const tipo = document.getElementById('filterTipo').value;
  const operacao = document.getElementById('filterOperacao').value;

  return rawData.filter(d=> 
    (cidade==='' || d.cidade===cidade) &&
    (bairro==='' || d.bairro===bairro) &&
    (tipo==='' || d.tipo===tipo) &&
    (operacao==='' || d.operacao===operacao)
  );
}

// Função para agregar média de preço por chave
function aggregateAvg(data, key) {
  const grouped = {};
  data.forEach(d=>{
    if(!grouped[d[key]]) grouped[d[key]] = {sum:0, count:0};
    grouped[d[key]].sum += d.preco;
    grouped[d[key]].count++;
  });
  return Object.entries(grouped).map(([k,v])=>[k, v.sum/v.count]);
}

// Desenhar gráficos
function drawAllCharts() {
  const data = getFilteredData();

  // Preço médio por Cidade
  let dataCidade = new google.visualization.DataTable();
  dataCidade.addColumn('string', 'Cidade');
  dataCidade.addColumn('number', 'Preço Médio');
  aggregateAvg(data, 'cidade').forEach(d=>dataCidade.addRow(d));
  new google.visualization.ColumnChart(document.getElementById('chartCidade')).draw(dataCidade, {
    title:'Preço Médio por Cidade',
    is3D:true,
    hAxis:{title:'Cidade'},
    vAxis:{title:'Preço (R$)'},
    colors:['#3498db'],
    backgroundColor:'#f4f4f4'
  });

  // Preço médio por Bairro
  let dataBairro = new google.visualization.DataTable();
  dataBairro.addColumn('string', 'Bairro');
  dataBairro.addColumn('number', 'Preço Médio');
  aggregateAvg(data, 'bairro').forEach(d=>dataBairro.addRow(d));
  new google.visualization.ColumnChart(document.getElementById('chartBairro')).draw(dataBairro, {
    title:'Preço Médio por Bairro',
    is3D:true,
    hAxis:{title:'Bairro'},
    vAxis:{title:'Preço (R$)'},
    colors:['#e67e22'],
    backgroundColor:'#f4f4f4'
  });

  // Preço médio por Tipo
  let dataTipo = new google.visualization.DataTable();
  dataTipo.addColumn('string', 'Tipo');
  dataTipo.addColumn('number', 'Preço Médio');
  aggregateAvg(data, 'tipo').forEach(d=>dataTipo.addRow(d));
  new google.visualization.ColumnChart(document.getElementById('chartTipo')).draw(dataTipo, {
    title:'Preço Médio por Tipo',
    is3D:true,
    hAxis:{title:'Tipo'},
    vAxis:{title:'Preço (R$)'},
    colors:['#2ecc71'],
    backgroundColor:'#f4f4f4'
  });

  // Preço médio por Operação
  let dataOperacao = new google.visualization.DataTable();
  dataOperacao.addColumn('string', 'Operação');
  dataOperacao.addColumn('number', 'Preço Médio');
  aggregateAvg(data, 'operacao').forEach(d=>dataOperacao.addRow(d));
  new google.visualization.ColumnChart(document.getElementById('chartOperacao')).draw(dataOperacao, {
    title:'Preço Médio por Operação',
    is3D:true,
    hAxis:{title:'Operação'},
    vAxis:{title:'Preço (R$)'},
    colors:['#9b59b6'],
    backgroundColor:'#f4f4f4'
  });

  // Preço médio por Operação + Tipo
  let grouped = {};
  data.forEach(d=>{
    const key = d.operacao + ' - ' + d.tipo;
    if(!grouped[key]) grouped[key] = {sum:0, count:0};
    grouped[key].sum += d.preco;
    grouped[key].count++;
  });
  let dataOpTipo = new google.visualization.DataTable();
  dataOpTipo.addColumn('string', 'Operação - Tipo');
  dataOpTipo.addColumn('number', 'Preço Médio');
  Object.entries(grouped).forEach(([k,v])=>dataOpTipo.addRow([k, v.sum/v.count]));
  new google.visualization.BarChart(document.getElementById('chartOperacaoTipo')).draw(dataOpTipo, {
    title:'Preço Médio por Operação + Tipo',
    is3D:true,
    hAxis:{title:'Preço (R$)'},
    vAxis:{title:'Operação - Tipo'},
    colors:['#e74c3c'],
    backgroundColor:'#f4f4f4'
  });
}
</script>
</body>
</html>
