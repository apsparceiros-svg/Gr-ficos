<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Profissional - Imóveis</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
body { font-family: Arial, sans-serif; background:#f4f4f9; margin:0; padding:20px; }
h1 { text-align:center; color:#8e44ad; }
.controls { display:flex; gap:15px; justify-content:center; margin-bottom:20px; flex-wrap:wrap; }
.controls select { padding:8px; border-radius:5px; border:1px solid #ccc; }
.chart { width:100%; max-width:1000px; margin:0 auto 50px; height:600px; }
</style>
</head>
<body>
<h1>Dashboard Profissional - Imóveis</h1>

<div class="controls">
  <select id="filterCidade">
    <option value="">Todas as Cidades</option>
  </select>
  <select id="filterBairro">
    <option value="">Todos os Bairros</option>
  </select>
  <select id="filterOperacao">
    <option value="">Todas Operações</option>
  </select>
  <select id="filterTipo">
    <option value="">Todos os Tipos</option>
  </select>
</div>

<div id="chart1" class="chart"></div>
<div id="chart2" class="chart"></div>
<div id="chart3" class="chart"></div>

<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQP-T1jc4Rpdigxqpkf7cL0MYiA8IESg1ATBwVdT7gTTPaMll_LGuwj0zOfbeEIO8Qv3DOZsK6eNBrZ/pub?gid=11391417&single=true&output=csv";

let rawData = [];
let filters = {cidade:"", bairro:"", operacao:"", tipo:""};

function fetchData() {
    Papa.parse(csvUrl, {
        download: true,
        header: true,
        dynamicTyping: true,
        complete: function(results) {
            rawData = results.data;
            populateFilters();
            updateCharts();
        }
    });
}

function populateFilters() {
    const cidades = [...new Set(rawData.map(d=>d.cidade).filter(Boolean))].sort();
    const bairros = [...new Set(rawData.map(d=>d.bairro).filter(Boolean))].sort();
    const operacoes = [...new Set(rawData.map(d=>d.operacao).filter(Boolean))].sort();
    const tipos = [...new Set(rawData.map(d=>d.tipo).filter(Boolean))].sort();

    const selectCidade = document.getElementById('filterCidade');
    cidades.forEach(c=>{ selectCidade.innerHTML += `<option value="${c}">${c}</option>`; });

    const selectBairro = document.getElementById('filterBairro');
    bairros.forEach(b=>{ selectBairro.innerHTML += `<option value="${b}">${b}</option>`; });

    const selectOperacao = document.getElementById('filterOperacao');
    operacoes.forEach(o=>{ selectOperacao.innerHTML += `<option value="${o}">${o}</option>`; });

    const selectTipo = document.getElementById('filterTipo');
    tipos.forEach(t=>{ selectTipo.innerHTML += `<option value="${t}">${t}</option>`; });

    // Event listeners
    selectCidade.onchange = (e)=>{ filters.cidade=e.target.value; updateCharts(); };
    selectBairro.onchange = (e)=>{ filters.bairro=e.target.value; updateCharts(); };
    selectOperacao.onchange = (e)=>{ filters.operacao=e.target.value; updateCharts(); };
    selectTipo.onchange = (e)=>{ filters.tipo=e.target.value; updateCharts(); };
}

function filterData() {
    return rawData.filter(d=>{
        return (!filters.cidade || d.cidade===filters.cidade)
            && (!filters.bairro || d.bairro===filters.bairro)
            && (!filters.operacao || d.operacao===filters.operacao)
            && (!filters.tipo || d.tipo===filters.tipo);
    });
}

function aggregateData(fieldX, fieldY="preco") {
    const data = filterData();
    const result = {};
    data.forEach(d=>{
        const key = d[fieldX] || "N/A";
        if(!result[key]) result[key] = [];
        result[key].push(d[fieldY]);
    });
    const labels = Object.keys(result);
    const values = labels.map(k=>{
        const arr = result[k].filter(v=>!isNaN(v));
        return arr.length? arr.reduce((a,b)=>a+b,0)/arr.length : 0;
    });
    return {labels, values};
}

function updateCharts() {
    // Chart 1: Preço médio por Cidade
    const c1 = aggregateData("cidade");
    Plotly.newPlot('chart1',[{
        x: c1.labels, y: c1.values,
        type:'bar', marker:{color:'#8e44ad'}
    }],{title:'Preço Médio por Cidade', margin:{t:50}});

    // Chart 2: Preço médio por Bairro
    const c2 = aggregateData("bairro");
    Plotly.newPlot('chart2',[{
        x: c2.labels, y: c2.values,
        type:'bar', marker:{color:'#3498db'}
    }],{title:'Preço Médio por Bairro', margin:{t:50}});

    // Chart 3: Preço médio por Operação + Tipo
    const data = filterData();
    const combinations = {};
    data.forEach(d=>{
        const key = `${d.operacao || 'N/A'} - ${d.tipo || 'N/A'}`;
        if(!combinations[key]) combinations[key] = [];
        combinations[key].push(d.preco);
    });
    const labels = Object.keys(combinations);
    const values = labels.map(k=>{
        const arr = combinations[k].filter(v=>!isNaN(v));
        return arr.length? arr.reduce((a,b)=>a+b,0)/arr.length : 0;
    });
    Plotly.newPlot('chart3',[{
        x: labels, y: values,
        type:'bar', marker:{color:'#e67e22'}
    }],{title:'Preço Médio por Operação + Tipo', margin:{t:50, b:150}});
}

fetchData();
</script>
</body>
</html>
