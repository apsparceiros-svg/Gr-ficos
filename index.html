<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Completo - Imóveis</title>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; background: #f4f4f9; margin: 0; padding: 20px; }
  h2 { text-align:center; margin-bottom:20px; color:#4a148c; }
  .charts-wrapper {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
  }
  .chart-container {
    background: #fff;
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }
</style>
</head>
<body>
<h2>Dashboard Completo de Imóveis</h2>
<div class="charts-wrapper" id="charts-wrapper"></div>

<script>
google.charts.load('current', {'packages':['corechart', 'bar']});
google.charts.setOnLoadCallback(loadData);

const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQP-T1jc4Rpdigxqpkf7cL0MYiA8IESg1ATBwVdT7gTTPaMll_LGuwj0zOfbeEIO8Qv3DOZsK6eNBrZ/pub?gid=11391417&single=true&output=csv";

function loadData() {
  Papa.parse(csvUrl, {
    download: true,
    header: true,
    dynamicTyping: true,
    complete: function(results) {
      const data = results.data.filter(row => row.preco != null && row.preco !== "");
      drawAllCharts(data);
    }
  });
}

function drawAllCharts(data) {
  const chartsWrapper = document.getElementById('charts-wrapper');

  const groupBy = (arr, keys) => {
    return arr.reduce((acc, item) => {
      const groupKey = keys.map(k => item[k] || "").join(" | ");
      if (!acc[groupKey]) acc[groupKey] = [];
      acc[groupKey].push(item);
      return acc;
    }, {});
  }

  const avgPrice = arr => arr.reduce((sum, i) => sum + i.preco, 0)/arr.length;

  // Lista de combinações e cores
  const combinations = [
    {keys:['operacao'], title:'Preço Médio por Operação', color:'#e67e22'},
    {keys:['tipo'], title:'Preço Médio por Tipo', color:'#3498db'},
    {keys:['cidade'], title:'Preço Médio por Cidade', color:'#2ecc71'},
    {keys:['bairro'], title:'Preço Médio por Bairro', color:'#8e44ad'},
    {keys:['operacao','tipo'], title:'Operação + Tipo', color:'#f39c12'},
    {keys:['cidade','bairro'], title:'Cidade + Bairro', color:'#16a085'},
    {keys:['tipo','cidade'], title:'Tipo + Cidade', color:'#9b59b6'},
    {keys:['operacao','cidade'], title:'Operação + Cidade', color:'#d35400'}
  ];

  combinations.forEach((comb,i) => {
    const grouped = groupBy(data, comb.keys);
    const chartData = new google.visualization.DataTable();
    chartData.addColumn('string', comb.keys.join(' + '));
    chartData.addColumn('number', 'Preço Médio (R$)');
    chartData.addColumn({type:'string', role:'tooltip'});

    for(const key in grouped){
      const avg = avgPrice(grouped[key]);
      chartData.addRow([key, avg, `${key}\nPreço Médio: R$ ${avg.toFixed(2)}`]);
    }

    const div = document.createElement('div');
    div.className = 'chart-container';
    div.id = 'chart'+i;
    chartsWrapper.appendChild(div);

    const chart = new google.visualization.ColumnChart(div);
    chart.draw(chartData, {
      title: comb.title,
      is3D:true,
      legend:'none',
      colors:[comb.color],
      hAxis:{title: comb.keys.join(' + ')},
      vAxis:{title:'Preço Médio (R$)'},
      backgroundColor:'#f4f4f9',
      animation:{startup:true,duration:800,easing:'out'}
    });
  });
}
</script>
</body>
</html>
