<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Avançado - Imóveis Dinâmico</title>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
body { font-family:'Roboto', sans-serif; background:#f4f4f9; margin:0; padding:0; color:#333;}
h2 { text-align:center; color:#8e44ad; margin:20px 0;}
.wrapper { display:flex; flex-wrap:wrap; justify-content:center; gap:30px; padding:20px;}
.chart-container { background:#fff; border-radius:12px; padding:15px; box-shadow:0 4px 12px rgba(0,0,0,0.1); max-width:600px; flex:1 1 500px;}
#filters { display:flex; gap:20px; justify-content:center; flex-wrap:wrap; margin-bottom:20px;}
select { padding:8px 12px; border-radius:6px; border:1px solid #d3b28d; background:#fff;}
</style>
<script>
google.charts.load('current', {packages:['corechart','controls','bar','table']});
google.charts.setOnLoadCallback(loadData);

const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQP-T1jc4Rpdigxqpkf7cL0MYiA8IESg1ATBwVdT7gTTPaMll_LGuwj0zOfbeEIO8Qv3DOZsK6eNBrZ/pub?gid=11391417&single=true&output=csv";

let data; // Tabela base

function loadData(){
    Papa.parse(csvUrl, {
        download: true,
        header: true,
        complete: function(results){
            const rows = results.data.filter(r => r.preco);
            data = new google.visualization.DataTable();
            data.addColumn('string','Operação');
            data.addColumn('string','Tipo');
            data.addColumn('string','Cidade');
            data.addColumn('string','Bairro');
            data.addColumn('number','Preço');
            data.addColumn('number','Área');

            rows.forEach(r=>{
                data.addRow([
                    r.operacao||"",
                    r.tipo||"",
                    r.cidade||"",
                    r.bairro||"",
                    Number(r.preco)||0,
                    Number(r.area)||0
                ]);
            });

            drawDashboard();
        }
    });
}

function drawDashboard() {
    const dashboard = new google.visualization.Dashboard(document.getElementById('dashboard'));

    const operationFilter = new google.visualization.ControlWrapper({
        controlType:'CategoryFilter',
        containerId:'filter_operacao',
        options:{filterColumnLabel:'Operação', ui:{allowTyping:false, allowMultiple:true}}
    });

    const typeFilter = new google.visualization.ControlWrapper({
        controlType:'CategoryFilter',
        containerId:'filter_tipo',
        options:{filterColumnLabel:'Tipo', ui:{allowTyping:false, allowMultiple:true}}
    });

    const cityFilter = new google.visualization.ControlWrapper({
        controlType:'CategoryFilter',
        containerId:'filter_cidade',
        options:{filterColumnLabel:'Cidade', ui:{allowTyping:false, allowMultiple:true}}
    });

    // Gráficos
    const chartBairro = new google.visualization.ChartWrapper({
        chartType:'ColumnChart',
        containerId:'chart_bairro',
        options:{title:'Preço Médio por Bairro', is3D:true, height:400, legend:'none', colors:['#e67e22'], animation:{duration:500,easing:'out',startup:true}}
    });

    const chartOperacao = new google.visualization.ChartWrapper({
        chartType:'ColumnChart',
        containerId:'chart_operacao',
        options:{title:'Preço Médio por Operação', is3D:true, height:400, legend:'none', colors:['#3498db'], animation:{duration:500,easing:'out',startup:true}}
    });

    const chartOperacaoTipo = new google.visualization.ChartWrapper({
        chartType:'BarChart',
        containerId:'chart_operacao_tipo',
        options:{title:'Operação + Tipo x Preço', is3D:true, height:400, colors:['#2ecc71','#9b59b6'], animation:{duration:500,easing:'out',startup:true}}
    });

    const chartScatter = new google.visualization.ChartWrapper({
        chartType:'ScatterChart',
        containerId:'chart_scatter',
        options:{title:'Preço x Área', height:400, hAxis:{title:'Área (m²)'}, vAxis:{title:'Preço (R$)'}, colors:['#e74c3c'], animation:{duration:500,easing:'out',startup:true}}
    });

    const chartTopBairros = new google.visualization.ChartWrapper({
        chartType:'BarChart',
        containerId:'chart_top_bairros',
        options:{title:'Top 10 Bairros mais caros', height:400, colors:['#f39c12'], legend:'none', animation:{duration:500,easing:'out',startup:true}}
    });

    const chartHeatmap = new google.visualization.ChartWrapper({
        chartType:'Table',
        containerId:'chart_heatmap',
        options:{showRowNumber:false, width:'100%', height:400, allowHtml:true}
    });

    // Função para atualizar gráficos dinamicamente
    function updateCharts() {
        const view = new google.visualization.DataView(data);
        const filteredRows = view.getFilteredRows([]); // pega todas as linhas filtradas pelos controles
        const rows = filteredRows.map(r => {
            return {
                operacao: data.getValue(r,0),
                tipo: data.getValue(r,1),
                cidade: data.getValue(r,2),
                bairro: data.getValue(r,3),
                preco: data.getValue(r,4),
                area: data.getValue(r,5)
            };
        });

        // Função de agregação
        const agregateBy = (arr,keyCol,valueCol) => {
            const map = {};
            arr.forEach(r=>{
                const key = r[keyCol]||"";
                if(!map[key]) map[key] = [];
                map[key].push(r[valueCol]||0);
            });
            const result = [];
            Object.keys(map).forEach(k=>{
                const vals = map[k];
                const media = vals.reduce((a,b)=>a+b,0)/vals.length;
                result.push([k, media]);
            });
            return result;
        };

        // Bairro
        const bairroData = new google.visualization.DataTable();
        bairroData.addColumn('string','Bairro');
        bairroData.addColumn('number','Preço Médio');
        agregateBy(rows,'bairro','preco').forEach(r=>bairroData.addRow(r));
        chartBairro.setDataTable(bairroData);

        // Operação
        const operacaoData = new google.visualization.DataTable();
        operacaoData.addColumn('string','Operação');
        operacaoData.addColumn('number','Preço Médio');
        agregateBy(rows,'operacao','preco').forEach(r=>operacaoData.addRow(r));
        chartOperacao.setDataTable(operacaoData);

        // Operação + Tipo
        const operacaoTipoMap = {};
        rows.forEach(r=>{
            const key = r.operacao+'|'+r.tipo;
            if(!operacaoTipoMap[key]) operacaoTipoMap[key] = [];
            operacaoTipoMap[key].push(r.preco||0);
        });
        const operacaoTipoData = new google.visualization.DataTable();
        operacaoTipoData.addColumn('string','Operação');
        operacaoTipoData.addColumn('string','Tipo');
        operacaoTipoData.addColumn('number','Preço Médio');
        Object.keys(operacaoTipoMap).forEach(k=>{
            const [op,tipo] = k.split('|');
            const vals = operacaoTipoMap[k];
            const media = vals.reduce((a,b)=>a+b,0)/vals.length;
            operacaoTipoData.addRow([op,tipo,media]);
        });
        chartOperacaoTipo.setDataTable(operacaoTipoData);

        // Scatter
        const scatterData = new google.visualization.DataTable();
        scatterData.addColumn('number','Área');
        scatterData.addColumn('number','Preço');
        rows.forEach(r=>scatterData.addRow([r.area,r.preco]));
        chartScatter.setDataTable(scatterData);

        // Top 10 bairros
        const topBairros = agregateBy(rows,'bairro','preco')
            .sort((a,b)=>b[1]-a[1])
            .slice(0,10);
        const topBairrosData = new google.visualization.DataTable();
        topBairrosData.addColumn('string','Bairro');
        topBairrosData.addColumn('number','Preço Médio');
        topBairros.forEach(r=>topBairrosData.addRow(r));
        chartTopBairros.setDataTable(topBairrosData);

        // Heatmap
        const heatmapMap = {};
        rows.forEach(r=>{
            const key = r.cidade+'|'+r.tipo;
            if(!heatmapMap[key]) heatmapMap[key] = [];
            heatmapMap[key].push(r.preco||0);
        });
        const heatmapData = new google.visualization.DataTable();
        heatmapData.addColumn('string','Cidade');
        heatmapData.addColumn('string','Tipo');
        heatmapData.addColumn('number','Preço Médio');
        heatmapData.addColumn({type:'string', role:'style'});
        Object.keys(heatmapMap).forEach(k=>{
            const [cidade,tipo] = k.split('|');
            const vals = heatmapMap[k];
            const media = vals.reduce((a,b)=>a+b,0)/vals.length;
            let cor='#2ecc71';
            if(media>500000) cor='#e74c3c';
            else if(media>300000) cor='#f1c40f';
            heatmapData.addRow([cidade,tipo,media,'background-color:'+cor]);
        });
        chartHeatmap.setDataTable(heatmapData);
    }

    // Atualiza gráficos quando filtros mudam
    google.visualization.events.addListener(operationFilter, 'statechange', updateCharts);
    google.visualization.events.addListener(typeFilter, 'statechange', updateCharts);
    google.visualization.events.addListener(cityFilter, 'statechange', updateCharts);

    dashboard.bind([operationFilter,typeFilter,cityFilter],[]);
    dashboard.draw(data);

    // Inicializa gráficos
    updateCharts();
}
</script>
</head>
<body>
<h2>Dashboard Avançado - Imóveis Dinâmico</h2>
<div id="filters">
    <div id="filter_operacao"></div>
    <div id="filter_tipo"></div>
    <div id="filter_cidade"></div>
</div>
<div class="wrapper" id="dashboard">
    <div class="chart-container" id="chart_bairro"></div>
    <div class="chart-container" id="chart_operacao"></div>
    <div class="chart-container" id="chart_operacao_tipo"></div>
    <div class="chart-container" id="chart_scatter"></div>
    <div class="chart-container" id="chart_top_bairros"></div>
    <div class="chart-container" id="chart_heatmap"></div>
</div>
</body>
</html>
