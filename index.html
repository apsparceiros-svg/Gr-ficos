<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Interativo de Imóveis</title>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
google.charts.load('current', {'packages':['corechart', 'bar']});
google.charts.setOnLoadCallback(init);

const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQP-T1jc4Rpdigxqpkf7cL0MYiA8IESg1ATBwVdT7gTTPaMll_LGuwj0zOfbeEIO8Qv3DOZsK6eNBrZ/pub?gid=11391417&single=true&output=csv';
let allData = [];

function init() {
    Papa.parse(csvUrl, {
        download: true,
        header: true,
        dynamicTyping: true,
        complete: function(results) {
            allData = results.data.filter(r => r.preco && !isNaN(r.preco));
            populateFilters();
            drawAllCharts(allData);
        }
    });
}

// Popula filtros dinamicamente
function populateFilters() {
    const filtros = ['cidade', 'bairro', 'tipo', 'operacao'];
    filtros.forEach(f => {
        const select = document.getElementById(f + '_filter');
        const unique = [...new Set(allData.map(d => d[f]).filter(v => v))].sort();
        select.innerHTML = '<option value="">Todos</option>' + unique.map(v => `<option value="${v}">${v}</option>`).join('');
        select.addEventListener('change', updateCharts);
    });
}

function filterData() {
    return allData.filter(r => {
        return (!document.getElementById('cidade_filter').value || r.cidade === document.getElementById('cidade_filter').value) &&
               (!document.getElementById('bairro_filter').value || r.bairro === document.getElementById('bairro_filter').value) &&
               (!document.getElementById('tipo_filter').value || r.tipo === document.getElementById('tipo_filter').value) &&
               (!document.getElementById('operacao_filter').value || r.operacao === document.getElementById('operacao_filter').value);
    });
}

function aggregateAverage(data, key) {
    const map = {};
    data.forEach(r => {
        if (!map[r[key]]) map[r[key]] = {total:0,count:0};
        map[r[key]].total += r.preco;
        map[r[key]].count += 1;
    });
    return Object.keys(map).map(k => [k, map[k].total / map[k].count]);
}

function aggregateOpTipo(data) {
    const map = {};
    data.forEach(r => {
        const key = r.operacao + " | " + r.tipo;
        if (!map[key]) map[key] = {total:0,count:0};
        map[key].total += r.preco;
        map[key].count += 1;
    });
    return Object.keys(map).map(k => [k, map[k].total / map[k].count]);
}

function drawAllCharts(filteredData) {
    // Preço médio por Bairro
    let bairroData = new google.visualization.DataTable();
    bairroData.addColumn('string', 'Bairro');
    bairroData.addColumn('number', 'Preço Médio');
    bairroData.addRows(aggregateAverage(filteredData, 'bairro'));
    new google.visualization.ColumnChart(document.getElementById('chart_bairro'))
        .draw(bairroData, {title:'Preço Médio por Bairro', is3D:true, height:350, colors:['#1f77b4']});

    // Preço médio por Cidade
    let cidadeData = new google.visualization.DataTable();
    cidadeData.addColumn('string', 'Cidade');
    cidadeData.addColumn('number', 'Preço Médio');
    cidadeData.addRows(aggregateAverage(filteredData, 'cidade'));
    new google.visualization.ColumnChart(document.getElementById('chart_cidade'))
        .draw(cidadeData, {title:'Preço Médio por Cidade', is3D:true, height:350, colors:['#ff7f0e']});

    // Preço médio por Tipo
    let tipoData = new google.visualization.DataTable();
    tipoData.addColumn('string', 'Tipo');
    tipoData.addColumn('number', 'Preço Médio');
    tipoData.addRows(aggregateAverage(filteredData, 'tipo'));
    new google.visualization.ColumnChart(document.getElementById('chart_tipo'))
        .draw(tipoData, {title:'Preço Médio por Tipo', is3D:true, height:350, colors:['#2ca02c']});

    // Preço médio por Operação
    let operacaoData = new google.visualization.DataTable();
    operacaoData.addColumn('string', 'Operação');
    operacaoData.addColumn('number', 'Preço Médio');
    operacaoData.addRows(aggregateAverage(filteredData, 'operacao'));
    new google.visualization.ColumnChart(document.getElementById('chart_operacao'))
        .draw(operacaoData, {title:'Preço Médio por Operação', is3D:true, height:350, colors:['#d62728']});

    // Operação + Tipo
    let opTipoData = new google.visualization.DataTable();
    opTipoData.addColumn('string', 'Operação | Tipo');
    opTipoData.addColumn('number', 'Preço Médio');
    opTipoData.addRows(aggregateOpTipo(filteredData));
    new google.visualization.BarChart(document.getElementById('chart_op_tipo'))
        .draw(opTipoData, {title:'Preço Médio por Operação e Tipo', height:400, colors:['#9467bd']});

    // Top 10 imóveis por preço
    let topData = new google.visualization.DataTable();
    topData.addColumn('string', 'Título');
    topData.addColumn('number', 'Preço');
    topData.addColumn({type: 'string', role: 'tooltip'});
    const top10 = filteredData.sort((a,b)=>b.preco-a.preco).slice(0,10);
    top10.forEach(r => topData.addRow([r.titulo, r.preco, `Ref: ${r.ref}\n${r.titulo}\nPreço: R$ ${r.preco}`]));
    new google.visualization.ColumnChart(document.getElementById('chart_top10'))
        .draw(topData, {title:'Top 10 Imóveis por Preço', height:400, colors:['#17becf'], tooltip:{isHtml:true}});
}

function updateCharts() {
    drawAllCharts(filterData());
}
</script>
<style>
body {font-family: Arial, sans-serif; background:#f4f4f9; color:#333;}
h1 {text-align:center; margin-top:20px;}
.filters {width:90%; max-width:1200px; margin:20px auto; display:flex; gap:15px; flex-wrap:wrap;}
.filters select {padding:8px; font-size:14px; border-radius:5px; border:1px solid #ccc;}
.chart-container {width:90%; max-width:1200px; margin:20px auto;}
#chart_bairro, #chart_cidade, #chart_tipo, #chart_operacao, #chart_op_tipo, #chart_top10 {
    margin-bottom:40px; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.1);
}
</style>
</head>
<body>
<h1>Dashboard Interativo Profissional de Imóveis</h1>

<div class="filters">
    <select id="cidade_filter"></select>
    <select id="bairro_filter"></select>
    <select id="tipo_filter"></select>
    <select id="operacao_filter"></select>
</div>

<div class="chart-container">
    <div id="chart_bairro"></div>
    <div id="chart_cidade"></div>
    <div id="chart_tipo"></div>
    <div id="chart_operacao"></div>
    <div id="chart_op_tipo"></div>
    <div id="chart_top10"></div>
</div>
</body>
</html>
